<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Relatório de Desempenho - Banco Malvader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container-custom {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .filters-section {
            background: #fff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .kpi-card {
            background: #fff;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            border-top: 4px solid #3498db;
        }
        .kpi-card.success { border-top-color: #27ae60; }
        .kpi-card.danger { border-top-color: #e74c3c; }
        .kpi-card.warning { border-top-color: #f39c12; }
        .kpi-card.info { border-top-color: #17a2b8; }
        .kpi-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .kpi-trend {
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        .trend-up { color: #27ae60; }
        .trend-down { color: #e74c3c; }
        .trend-neutral { color: #6c757d; }
        .chart-container {
            background: #fff;
            border-radius: 12px;
            padding: 2rem;
            margin: 1.5rem 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            height: 400px;
        }
        .performance-table {
            background: #fff;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .employee-rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.8rem;
        }
        .rank-1 { background: #f39c12; }
        .rank-2 { background: #95a5a6; }
        .rank-3 { background: #cd7f32; }
        .rank-other { background: #3498db; }
        .alert {
            border-radius: 8px;
        }
        .permission-alert {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        @media print {
            .btn, .permission-alert, .filters-section {
                display: none !important;
            }
            body {
                background-color: white !important;
            }
            .kpi-card, .chart-container, .performance-table {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
        }
    </style>
</head>
<body>

<div class="container-custom">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4><i class="fas fa-chart-line me-2"></i>Relatório de Desempenho</h4>
            <p class="text-muted mb-0">Métricas e indicadores de performance</p>
        </div>
        <a href="/funcionario/relatorios" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Voltar
        </a>
    </div>

    <!-- Alerta de Permissão -->
    <div class="permission-alert">
        <h6><i class="fas fa-shield-alt text-warning me-2"></i>Acesso Restrito</h6>
        <p class="mb-0">Esta funcionalidade está disponível apenas para usuários com perfil de <strong>Gerente</strong>.</p>
    </div>

    <!-- Mensagens -->
    <div th:if="${sucesso}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        <span th:text="${sucesso}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${erro}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span th:text="${erro}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Filtros -->
    <div class="filters-section">
        <h5 class="mb-3"><i class="fas fa-filter me-2"></i>Período de Análise</h5>
        <form action="/funcionario/relatorios/desempenho" method="post">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="periodo" class="form-label">Período</label>
                    <select class="form-select" id="periodo" name="periodo" onchange="toggleCustomDates()">
                        <option value="ULTIMO_MES">Último Mês</option>
                        <option value="ULTIMO_TRIMESTRE">Último Trimestre</option>
                        <option value="ULTIMO_SEMESTRE">Último Semestre</option>
                        <option value="ULTIMO_ANO">Último Ano</option>
                        <option value="PERSONALIZADO">Personalizado</option>
                    </select>
                </div>
                <div class="col-md-3" id="customStartGroup" style="display: none;">
                    <label for="dataInicio" class="form-label">Data Início</label>
                    <input type="date" class="form-control" id="dataInicio" name="dataInicio">
                </div>
                <div class="col-md-3" id="customEndGroup" style="display: none;">
                    <label for="dataFim" class="form-label">Data Fim</label>
                    <input type="date" class="form-control" id="dataFim" name="dataFim">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-sync me-1"></i>Atualizar Dados
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- KPIs Principais -->
    <div class="kpi-grid">
        <div class="kpi-card success">
            <div class="kpi-value text-success" th:text="'R$ ' + ${#numbers.formatDecimal(kpis.receitaTotal, 1, 2, 'POINT')}">R$ 0,00</div>
            <div class="kpi-title">Receita Total</div>
            <div class="kpi-trend trend-up" th:if="${kpis.variacaoReceita > 0}">
                <i class="fas fa-arrow-up me-1"></i>
                <span th:text="${kpis.variacaoReceita} + '% vs período anterior'"></span>
            </div>
            <div class="kpi-trend trend-down" th:if="${kpis.variacaoReceita < 0}">
                <i class="fas fa-arrow-down me-1"></i>
                <span th:text="${Math.abs(kpis.variacaoReceita)} + '% vs período anterior'"></span>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-value text-primary" th:text="${kpis.novosClientes}">0</div>
            <div class="kpi-title">Novos Clientes</div>
            <div class="kpi-trend trend-up" th:if="${kpis.variacaoClientes > 0}">
                <i class="fas fa-arrow-up me-1"></i>
                <span th:text="${kpis.variacaoClientes} + '%'"></span>
            </div>
        </div>

        <div class="kpi-card info">
            <div class="kpi-value text-info" th:text="${kpis.contasAbertas}">0</div>
            <div class="kpi-title">Contas Abertas</div>
            <div class="kpi-trend" th:classappend="${kpis.variacaoContas > 0} ? 'trend-up' : 'trend-down'">
                <i th:classappend="${kpis.variacaoContas > 0} ? 'fas fa-arrow-up' : 'fas fa-arrow-down'"></i>
                <span th:text="${Math.abs(kpis.variacaoContas)} + '%'"></span>
            </div>
        </div>

        <div class="kpi-card warning">
            <div class="kpi-value text-warning" th:text="'R$ ' + ${#numbers.formatDecimal(kpis.inadimplencia, 1, 2, 'POINT')}">R$ 0,00</div>
            <div class="kpi-title">Inadimplência</div>
            <div class="kpi-trend trend-down" th:if="${kpis.variacaoInadimplencia < 0}">
                <i class="fas fa-arrow-down me-1"></i>
                <span th:text="${Math.abs(kpis.variacaoInadimplencia)} + '%'"></span>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row">
        <div class="col-md-6">
            <div class="chart-container">
                <h6 class="text-center mb-3">Receita por Tipo</h6>
                <div class="text-center text-muted">
                    <i class="fas fa-chart-pie fa-3x mb-3 opacity-50"></i>
                    <p>Gráfico de Pizza - Receitas</p>
                    <small>Distribuição das receitas por tipo de transação</small>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <h6 class="text-center mb-3">Evolução Mensal</h6>
                <div class="text-center text-muted">
                    <i class="fas fa-chart-line fa-3x mb-3 opacity-50"></i>
                    <p>Gráfico de Linhas - Evolução</p>
                    <small>Performance ao longo do tempo</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Desempenho por Funcionário -->
    <div class="performance-table">
        <h5 class="mb-4"><i class="fas fa-user-tie me-2"></i>Desempenho por Funcionário</h5>

        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Funcionário</th>
                    <th>Cargo</th>
                    <th>Contas Abertas</th>
                    <th>Valor Movimentado</th>
                    <th>Clientes Atendidos</th>
                    <th>Score</th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="func, stat : ${desempenhoFuncionarios}">
                    <td>
                        <div th:classappend="'employee-rank ' +
                                                (${stat.count} == 1 ? 'rank-1' :
                                                 ${stat.count} == 2 ? 'rank-2' :
                                                 ${stat.count} == 3 ? 'rank-3' : 'rank-other')"
                             th:text="${stat.count}">
                        </div>
                    </td>
                    <td>
                        <strong th:text="${func.nome}"></strong>
                        <div class="text-muted small" th:text="${func.matricula}"></div>
                    </td>
                    <td>
                            <span th:classappend="'badge ' +
                                                (${func.cargo} == 'GERENTE' ? 'bg-danger' :
                                                 ${func.cargo} == 'ATENDENTE' ? 'bg-primary' : 'bg-success')"
                                  th:text="${func.cargo}">
                            </span>
                    </td>
                    <td th:text="${func.contasAbertas}">0</td>
                    <td th:text="'R$ ' + ${#numbers.formatDecimal(func.valorMovimentado, 1, 2, 'POINT')}">R$ 0,00</td>
                    <td th:text="${func.clientesAtendidos}">0</td>
                    <td>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar"
                                 th:classappend="${func.score >= 80} ? 'bg-success' :
                                                     ${func.score >= 60} ? 'bg-warning' : 'bg-danger'"
                                 th:style="'width: ' + ${func.score} + '%;'"
                                 role="progressbar">
                            </div>
                        </div>
                        <small th:text="${func.score} + '%'"></small>
                    </td>
                    <td>
                            <span th:if="${func.tendencia == 'ALTA'}" class="badge bg-success">
                                <i class="fas fa-arrow-up me-1"></i>Alta
                            </span>
                        <span th:if="${func.tendencia == 'ESTAVEL'}" class="badge bg-warning">
                                <i class="fas fa-minus me-1"></i>Estável
                            </span>
                        <span th:if="${func.tendencia == 'BAIXA'}" class="badge bg-danger">
                                <i class="fas fa-arrow-down me-1"></i>Baixa
                            </span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Métricas Adicionais -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="kpi-card">
                <div class="kpi-value" th:text="${kpis.taxaConversao} + '%'">0%</div>
                <div class="kpi-title">Taxa de Conversão</div>
                <small class="text-muted">Consultas para Contas Abertas</small>
            </div>
        </div>
        <div class="col-md-6">
            <div class="kpi-card">
                <div class="kpi-value" th:text="${kpis.satisfacao} + '%'">0%</div>
                <div class="kpi-title">Satisfação do Cliente</div>
                <small class="text-muted">Baseado em pesquisas</small>
            </div>
        </div>
    </div>

    <!-- Ações -->
    <div class="text-center mt-4">
        <button class="btn btn-outline-primary me-2" onclick="window.print()">
            <i class="fas fa-print me-1"></i>Imprimir Relatório
        </button>
        <button class="btn btn-outline-success" onclick="exportDashboard()">
            <i class="fas fa-download me-1"></i>Exportar Dashboard
        </button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Mostrar/ocultar datas personalizadas
    function toggleCustomDates() {
        const periodo = document.getElementById('periodo').value;
        const startGroup = document.getElementById('customStartGroup');
        const endGroup = document.getElementById('customEndGroup');

        if (periodo === 'PERSONALIZADO') {
            startGroup.style.display = 'block';
            endGroup.style.display = 'block';
        } else {
            startGroup.style.display = 'none';
            endGroup.style.display = 'none';
        }
    }

    // Set default dates for custom period
    document.addEventListener('DOMContentLoaded', function() {
        const hoje = new Date();
        const umMesAtras = new Date();
        umMesAtras.setMonth(hoje.getMonth() - 1);

        document.getElementById('dataInicio').value = umMesAtras.toISOString().split('T')[0];
        document.getElementById('dataFim').value = hoje.toISOString().split('T')[0];

        // Inicializar o estado dos filtros
        toggleCustomDates();
    });

    // Função para exportar o dashboard
    function exportDashboard() {
        // Criar um elemento link para download
        const link = document.createElement('a');
        link.href = '/funcionario/relatorios/desempenho/exportar';
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // Mostrar mensagem de sucesso
        alert('Exportação iniciada! O relatório será baixado em breve.');
    }

    // Adicionar funcionalidade de busca na tabela (opcional)
    function searchTable() {
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Buscar funcionários...';
        input.className = 'form-control mb-3';
        input.onkeyup = function() {
            const filter = input.value.toLowerCase();
            const table = document.querySelector('.performance-table table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[1];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        tr[i].style.display = '';
                    } else {
                        tr[i].style.display = 'none';
                    }
                }
            }
        };

        const tableHeader = document.querySelector('.performance-table h5');
        tableHeader.parentNode.insertBefore(input, tableHeader.nextSibling);
    }

    // Inicializar funcionalidades extras quando a página carregar
    document.addEventListener('DOMContentLoaded', function() {
        // Adicionar busca se necessário
        // searchTable();

        // Adicionar tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
</body>
</html>